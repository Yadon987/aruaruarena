# あるあるアリーナ - 画面構成・遷移設計（完全版）

## 画面一覧

### 1. トップ/ランキング一覧＋投稿フォーム画面
**種類**: メイン画面（フルスクリーン）

**構成要素**:
- ヘッダー（ロゴ、タイトル、🔊 / 🔇 ミュートトグル）
- 投稿フォーム
  - ニックネーム入力（1-20文字）
  - あるある本文入力（3-30文字、grapheme単位）
  - 投稿ボタン
  - 折りたたみ可能（デフォルト: 開いている）
- ランキング表示エリア
  - TOP 20リスト
  - 各投稿: 順位、ニックネーム、本文、平均点
  - 自分の投稿はハイライト表示（LocalStorage）
- フッター
  - 「自分の投稿一覧」ボタン
  - 「プライバシーポリシー」リンク
- **BGM**: ラデツキー行進曲（ループ再生）

**遷移先**:
- 投稿ボタン → POST /api/posts（成功時にIDをLocalStorageに保存） → **審査中画面**（フルスクリーン遷移）
- ランキング項目クリック → **審査結果/投稿詳細画面**（モーダル）
- 「自分の投稿一覧」ボタン → **自分の投稿一覧画面**（モーダル）
- 「プライバシーポリシー」リンク → **プライバシーポリシー画面**（モーダル）

---

### 2. 審査中画面
**種類**: フルスクリーン遷移

**構成要素**:
- 投稿内容表示（上部固定）
- 3人のAI審査員キャラクター
  - ひろゆき風（Gemini 2.5 Flash）
  - デヴィ婦人風（GLM-4.7-FlashX）
  - 中尾彬風（GPT-4o-mini）
- 審査アニメーション
  - キャラクターが動く（Framer Motion）
  - ランダムで口癖を発言
  - 審査中/完了のステータス表示
- ローディング表示
- 戻るボタンなし（審査完了まで待機）
- **BGM**: 道化師のギャロップ（ループ再生、審査中ずっと）

**遷移先**:
- 審査完了（成功/失敗問わず） → Framer Motionで画面全体がトップ画面にフェード遷移 → 同時に**審査結果/投稿詳細画面**（モーダル）が開く

---

### 3. 審査結果/投稿詳細画面
**種類**: モーダル

**構成要素**:
- 投稿情報
  - ニックネーム、本文、作成日時
  - 平均点（大きく表示）
  - ランキング順位/総投稿数
- 3人の審査員の詳細
  - 各審査員のアイコン・名前
  - 5項目スコア（共感度、面白さ、簡潔さ、独創性、表現力）
  - 合計点
  - コメント
  - 成功/失敗ステータス
- アクションボタン
  - **再審査ボタン**（失敗した審査員が1人以上いる場合に表示）
  - OGP画像プレビュー（シェア前に確認可能）
  - SNSシェアボタン（OGP画像付き、審査成功時のみ）
- **BGM**: 
  - 成功時（TOP20入り）: 威風堂々（ワンショット）
  - 失敗時（圏外）: 運命 冒頭（ワンショット）
  - 閉じるボタン
- 背景: トップ画面が薄く見える

**遷移先**:
- 再審査ボタン → モーダルを閉じる → トップ画面に戻る → **審査中画面**（フルスクリーン遷移、失敗した審査員のみ再実行）
- 閉じる → **トップ画面**に戻る

---

### 4. 自分の投稿一覧画面
**種類**: モーダル

**構成要素**:
- タイトル「自分の投稿」
- 投稿リスト（LocalStorageから取得）
  - 各投稿: 本文、平均点、順位、作成日時、審査ステータス
  - クリックで詳細表示
- 空状態メッセージ（投稿がない場合）
- 閉じるボタン
- 背景: トップ画面が薄く見える

**遷移先**:
- 投稿クリック → 自分の投稿一覧モーダルを閉じる → **審査結果/投稿詳細画面**（モーダル）が開く（モーダル切り替え）
- 閉じる → **トップ画面**に戻る

---

### 5. プライバシーポリシー画面
**種類**: モーダル

**構成要素**:
- タイトル「プライバシーポリシー」
- 利用規約・プライバシーポリシーの全文
  - データの取り扱い
  - 禁止事項
  - 免責事項
  - お問い合わせ先
- 閉じるボタン
- スクロール可能
- 背景: トップ画面が薄く見える

**遷移先**:
- 閉じる → **トップ画面**に戻る

---

## 画面遷移フロー図（完全版）

【投稿フロー】

トップ画面
  ↓ 投稿ボタン
POST /api/posts（成功時にIDをLocalStorageに保存）
  ↓
審査中画面（フルスクリーン遷移）
  ↓ 審査完了/失敗
トップ画面にフェード遷移 + 審査結果モーダルが同時に開く
  ↓ 閉じるボタン
トップ画面


【再審査フロー】

審査結果モーダル（失敗した審査員あり）
  ↓ 再審査ボタン
モーダルを閉じる → トップ画面に戻る
  ↓
審査中画面（フルスクリーン遷移、失敗した審査員のみ再実行）
  ↓ 審査完了/失敗
トップ画面にフェード遷移 + 審査結果モーダルが同時に開く
  ↓ 閉じるボタン
トップ画面


【ランキング閲覧フロー】

トップ画面
  ↓ ランキング項目クリック
審査結果/投稿詳細モーダルが開く
  ↓ 閉じるボタン
トップ画面


【自分の投稿閲覧フロー】

トップ画面
  ↓ 「自分の投稿一覧」ボタン
自分の投稿一覧モーダルが開く
  ↓ 投稿クリック
自分の投稿一覧モーダルを閉じる → 審査結果モーダルを開く（モーダル切り替え）
  ↓ 閉じるボタン
トップ画面


【プライバシーポリシー閲覧フロー】

トップ画面
  ↓ 「プライバシーポリシー」リンク
プライバシーポリシーモーダルが開く
  ↓ 閉じるボタン
トップ画面

---

## 技術スタック

### フロントエンド
- **React 18 + TypeScript**: UI実装
- **Vite**: ビルドツール
- **Framer Motion**: 画面遷移、キャラクターアニメーション、モーダル演出
- **TanStack Query**: API通信・キャッシュ
- **Tailwind CSS**: スタイリング

### バックエンド
- **Ruby 3.2.2 + Rails 8.0 (API mode)**: API実装
- **DynamoDB**: NoSQLデータベース
- **AWS Lambda**: サーバーレス実行環境

### AI APIs
- **Gemini 2.5 Flash** (Google) - ひろゆき風
- **GLM-4.7-FlashX** (Zhipu AI) - デヴィ婦人風
- **GPT-4o-mini** (OpenAI) - 中尾彬風

### 背景デザイン
- **Gemini (Imagen 3) / ナノバナナ**: AI生成背景画像
  - 審査員ごとに異なる雰囲気
  - ひろゆき風: クールで論理的な幾何学模様
  - デヴィ婦人風: 上品で華やかなゴールド系
  - 中尾彬風: 豪快で温かみのある和風テイスト

### データ管理
- **LocalStorage**: 自分の投稿ID管理（POST成功時に保存）

---

## 実装上の注意点

### フルスクリーン遷移
- Framer Motionの `AnimatePresence` を使用
- 審査中画面は没入感を最大化するため、背景をブラー処理せず完全に切り替え
- 審査完了時はトップ画面にフェード遷移し、同時に審査結果モーダルが開く
- 遷移時間: 0.5-0.8秒程度

Framer Motion実装例（概念）:

<AnimatePresence mode="wait">
  {showJudging && (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      transition={{ duration: 0.5 }}
    >
      <JudgingScreen />
    </motion.div>
  )}
</AnimatePresence>


### モーダル
- 背景は暗く半透明に（opacity: 0.5-0.7）
- `Esc` キーで閉じられる
- モーダル外クリックで閉じられる
- スクロールロック（body overflow: hidden）
- z-index管理: モーダル背景 (z-index: 40), モーダル本体 (z-index: 50)
- モーダル切り替え時はアニメーション（フェードアウト→フェードイン）

### LocalStorageの実装
- **保存タイミング**: POST /api/posts 成功時
- **保存内容**: 投稿IDの配列 `["uuid1", "uuid2", ...]`
- **キー名**: `aruaruarena_my_posts`
- **取得**: 起動時とランキング更新時にLocalStorageから取得し、ハイライト表示

LocalStorage実装例（概念）:

const saveMyPost = (postId: string) => {
  const myPosts = JSON.parse(localStorage.getItem('aruaruarena_my_posts') || '[]');
  myPosts.push(postId);
  localStorage.setItem('aruaruarena_my_posts', JSON.stringify(myPosts));
};


### レスポンシブ対応
- モバイルファースト設計
- 縦スクロールで全コンテンツが閲覧可能
- タッチ操作に最適化
- ブレークポイント: sm (640px), md (768px), lg (1024px)

### パフォーマンス
- 画像の遅延読み込み（Lazy Loading）
- モーダルコンポーネントの lazy load
- アニメーションのハードウェアアクセラレーション有効化（transform, opacity使用）
- TanStack Queryでのキャッシュ戦略
  - ランキング: 5分キャッシュ
  - 投稿詳細: 10分キャッシュ

### エラーハンドリング
- API失敗時: トースト通知でエラー表示
- 審査失敗時: 審査結果モーダルに再審査ボタン表示
- ネットワークエラー: リトライボタン表示

---

## 審査ステータスの定義

| ステータス | 説明 | 表示 |
|-----------|------|------|
| `judging` | 審査中 | 審査中画面でローディング表示 |
| `scored` | 審査成功（2人以上成功） | 審査結果モーダルに平均点・順位表示、SNSシェアボタン表示 |
| `failed` | 審査失敗（1人以下成功） | 審査結果モーダルに再審査ボタン表示、順位は「---」表示 |

---

## API連携フロー

### 投稿時

1. ユーザーが投稿ボタンをクリック
2. POST /api/posts リクエスト
3. レスポンス: `{ id: "uuid", status: "judging" }`
4. 投稿IDをLocalStorageに保存
5. 審査中画面に遷移（フルスクリーン）
6. ポーリング開始: GET /api/posts/:id （3秒ごと、最大60秒）
7. status が `scored` または `failed` になったら審査完了
8. トップ画面にフェード遷移 + 審査結果モーダルが開く
9. **タイムアウト時（60秒経過）**: エラーモーダル表示「審査に時間がかかっています。後ほど再度お試しください。」


### 再審査時

1. 審査結果モーダルで再審査ボタンをクリック
2. POST /api/posts/:id/rejudge リクエスト `{ failed_personas: ["dewi"] }`
3. モーダルを閉じる → トップ画面に戻る
4. 審査中画面に遷移（フルスクリーン）
5. ポーリング開始: GET /api/posts/:id （3秒ごと、最大60秒）
6. status が `scored` または `failed` になったら審査完了
7. トップ画面にフェード遷移 + 審査結果モーダルが開く


### ランキング取得

1. トップ画面表示時
2. GET /api/rankings リクエスト
3. レスポンス: `{ rankings: [...], total_count: 500 }`
4. ランキング表示、LocalStorageの投稿IDと照合してハイライト


---

## デザインガイドライン

### カラーパレット
- **プライマリ**: 審査員ごとに異なる色
  - ひろゆき風: #4A90E2 (青系)
  - デヴィ婦人風: #F5A623 (金系)
  - 中尾彬風: #D0021B (赤系)
- **背景**: グラデーション（AI生成）
- **テキスト**: #333333 (濃いグレー)
- **アクセント**: #FF6B6B (ハイライト・ボタン)

### タイポグラフィ
- **ヘッダー**: 24-32px, bold
- **本文**: 16-18px, regular
- **スコア表示**: 48-64px, bold
- **フォント**: Noto Sans JP（日本語）, Inter（英数字）

### スペーシング
- **セクション間**: 24-32px
- **要素間**: 16px
- **パディング**: 16-24px

### カラーモード
- **ライトモードのみ**（ダークモード非対応）

---

## セキュリティ・パフォーマンス考慮事項

### セキュリティ
- XSS対策: Reactの自動エスケープを活用
- CSRF対策: API GatewayのCORS設定
- レート制限: IP/ニックネームごとに5分1回（バックエンドで実装済み）
- 入力バリデーション: フロントエンド・バックエンド両方で実施

### パフォーマンス
- コード分割: React.lazy で審査中画面・モーダルを遅延読み込み
- 画像最適化: WebP形式、適切なサイズ
- CDN活用: CloudFront経由で配信
- バンドルサイズ削減: Tree shaking、未使用コード削除

---

## 今後の拡張可能性

- 審査員の追加（4人目、5人目）
- ユーザー登録機能（OAuth）
- いいね機能
- コメント機能
- お気に入り登録
- 期間限定ランキング（週間、月間）
- カテゴリ別投稿（ジャンル分け）
