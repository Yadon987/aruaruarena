================================================================================
Aruaru Arena 開発手順書
Claude Code＋GLM4.7＋Skills＋CodeRabbit＋TDD＋SDD
================================================================================

作成日: 2026年2月8日
バージョン: 2.0（Epic IDリナンバリング対応・実装順序更新・E01-E17統合）

================================================================================
目次
================================================================================
はじめに：前提知識
1. プロジェクト概要
2. 技術スタック
3. Epic一覧（E01-E17）
4. Windows 11 開発環境セットアップ
5. CodeRabbitのセットアップ
6. Skillsの使用方法
7. テスト環境構築（E01）の進捗
8. インフラ構築（AWS / Terraform）
9. 開発ワークフロー
10. 実装順序の推奨（フェーズ0〜5）
11. トラブルシューティング
12. プロダクション品質チェックリスト
13. 付録：プロジェクト設定ファイル
14. 用語集

================================================================================
はじめに：前提知識
================================================================================

この手順書では、以下の知識があることを前提としています。不安な場合は「10. 用語集」を参照してください。

【必要な前提知識】

1. **GitとGitHubの基礎**
   - Git: バージョン管理システム（変更履歴を管理するツール）
   - GitHub: GitリポジトリをホスティングするWebサービス
   - コミット: 変更を保存すること
   - ブランチ: 作業用の分岐
   - PR (Pull Request): 変更を本番ブランチにマージするリクエスト

2. **コマンドラインの基礎**
   - ターミナルでコマンドを実行できること
   - `cd` ディレクトリ移動、`ls` ファイル一覧などの基本コマンド

3. **プログラミングの基礎**
   - 変数、関数、クラス、メソッドなどの基本概念
   - API（Application Programming Interface）とは何か

【なぜWSL2なのか？】

Windows 11でLinux環境を動かすための仕組みです。
- 理由1: Ruby/Railsの開発環境はLinuxが標準的
- 理由2: 多くの開発ツールがLinuxで動作することを前提
- 理由3: WindowsとLinuxの共存が可能

【なぜDynamoDBなのか？】

Amazon Web Services (AWS) が提供するNoSQLデータベースです。
- 理由1: スケーラビリティ（大量のデータを高速に処理）
- 理由2: サーバーレス構成に適している
- 理由3: API経由でアクセス可能（Aruaru Arenaの審査システムに最適）

【なぜTDDなのか？】

テスト駆動開発（Test-Driven Development）の略です。
1. まずテストを書く（Red：失敗することを確認）
2. テストを通る実装を書く（Green：成功することを確認）
3. コードを整理する（Refactor：リファクタリング）

メリット：
- バグの早期発見
- 安全なリファクタリング
- 自然とテスト可能なコードになる

【なぜCodeRabbitなのか？】

AIコードレビューツールです。
- 機械的なチェック（typo、命名規則、セキュリティ）を自動化
- 人間は高度な判断に集中できる
- 24時間いつでもレビュー可能

================================================================================
1. プロジェクト概要
================================================================================

【Aruaru Arenaとは】

Ruby on Rails 8 API + DynamoDB で構築された「あるあるアリーナ」。
ユーザーの「あるある」投稿を3人のAI審査員（ひろゆき風/デヴィ婦人風/中尾彬風）
が採点・ランキング化する対戦型Webアプリ。

【AI審査員】

| 審査員 | キャラクター | AIモデル |
|--------|--------------|----------|
| 審査員1 | ひろゆき風 | Gemini 2.5 Flash |
| 審査員2 | デヴィ婦人風 | GLM-4.7-FlashX |
| 審査員3 | 中尾彬風 | GPT-4o-mini |

【審査ステータス】

| ステータス | 説明 |
|-----------|------|
| `judging` | 審査中（デフォルト） |
| `scored` | 審査成功（2人以上成功） |
| `failed` | 審査失敗（1人以下成功） |

【レート制限】
- 投稿: IP/ニックネームごとに5分1回

================================================================================
2. 技術スタック
================================================================================

| カテゴリ | 技術 | バージョン |
|---------|------|-----------|
| Backend | Ruby | 3.3+ |
| Framework | Rails | 8.0+ (API mode) |
| Database | DynamoDB | - |
| Serverless | AWS Lambda | - |
| Testing | RSpec | 8.0+ |
| Testing | FactoryBot | - |
| Frontend | React 18 + TypeScript | 別リポジトリ |
| AI APIs | Gemini, GLM, GPT | - |

================================================================================
3. Epic一覧（E01-E17）
================================================================================

本プロジェクトは17個のEpic（機能単位）で構成されています。詳細は `docs/epics.md` を参照してください。

**簡易Epic一覧**:

| Epic ID | Epic名 | 優先順位 | 依存関係 | ステータス |
|---------|--------|----------|----------|-----------|
| E01 | テスト環境構築（バックエンド） | P0（最優先） | なし | 進捗中 |
| E02 | インフラ構築（AWS） | P0（最優先） | なし | 完了 |
| E03 | DynamoDBスキーマ定義 | P0（最優先） | E02 |  |
| E04 | フロントエンド基盤構築 | P0（最優先） | なし |  |
| E05 | 投稿API | P0（最優先） | E03 |  |
| E06 | AI審査システム | P0（最優先） | E05 |  |
| E07 | 投稿詳細API | P0（最優先） | E06 |  |
| E08 | ランキングAPI | P1（高） | E06 |  |
| E09 | レート制限・スパム対策 | P1（高） | E05 |  |
| E10 | OGP画像生成 | P1（高） | E06 |  |
| E11 | 再審査API | P2（中） | E07 |  |
| E12 | トップ画面（フロントエンド） | P2（中） | E04, E05, E08 |  |
| E13 | 審査中画面（フロントエンド） | P2（中） | E04, E05 |  |
| E14 | 審査結果モーダル（フロントエンド） | P2（中） | E04, E07 |  |
| E15 | 自分の投稿一覧（フロントエンド） | P3（低） | E14 |  |
| E16 | プライバシーポリシー（フロントエンド） | P3（低） | E04 |  |
| E17 | BGM・SE再生 | P3（低） | E12, E13, E14 |  |

**詳細な仕様・ストーリー**: `docs/epics.md` を参照してください。

================================================================================
4. Windows 11 開発環境セットアップ
================================================================================

【前提環境】
- Windows 11 (22H2以降推奨)
- WSL2（Ubuntu推奨）
- Docker Desktop for Windows
- VSCode

■ 4-1. WSL2のインストールと設定

【WSL2とは？】
Windows上でLinuxを動かす仕組みです。Ruby/Railsの開発はLinux環境が標準的で、WSL2を使うことでWindowsとLinuxの良いとこ取りができます。

【PowerShellを管理者権限で開く方法】
1. スタートメニューで「PowerShell」を検索
2. 「Windows PowerShell」を右クリック
3. 「管理者として実行」をクリック

PowerShell（管理者）で実行：

```powershell
# WSL2のインストール
wsl --install

# 再起動後、Ubuntuをセットアップ
```

【インストール後のセットアップ】
1. PCが再起動されます
2. 自動的にUbuntuウィンドウが開きます
3. ユーザー名とパスワードを設定します
4. これでWSL2の準備完了です

WSL2内で開発環境を構築します。以降のコマンドはWSL2のUbuntu内で実行します。

■ 4-2. Docker Desktopのインストールと設定

1. Docker Desktop for Windows をインストール
   https://www.docker.com/products/docker-desktop/

2. 設定確認：
   - Settings → Resources → WSL Integration
   - 有効にするUbuntuディストリビューションにチェック

3. WSL2からDockerを使用可能か確認：

```bash
docker --version
docker ps
```

【重要：Docker Compose V2について】

Docker Compose V2がインストールされている場合、`docker-compose`（ハイフンあり）ではなく `docker compose`（スペースあり）コマンドを使用します。

```bash
# バージョン確認
docker compose version

# 使用方法
docker compose up -d    # サービス起動
docker compose down      # サービス停止
docker compose ps        # サービス一覧
```

`docker-compose` コマンドが見つからない場合は、`docker compose` を使用してください。

■ 4-3. Rubyのインストール（WSL2内）

【rbenvとruby-buildとは？】
- **rbenv**: Rubyのバージョンを切り替えるツール。複数のバージョンをインストールして管理できる。
- **ruby-build**: rbenvのプラグイン。Rubyの様々なバージョンを簡単にインストールできる。
- **なぜ使うのか？**: システムのRubyを汚さず、プロジェクトごとにRubyのバージョンを管理できる。

```bash
# 必要なパッケージをインストール
sudo apt update
sudo apt install -y git build-essential libyaml-dev libreadline-dev

# rbenvのインストール
git clone https://github.com/rbenv/rbenv.git ~/.rbenv
echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bashrc
echo 'eval "$(rbenv init - bash)"' >> ~/.bashrc
source ~/.bashrc

# ruby-buildのインストール
mkdir -p "$(rbenv root)"/plugins
git clone https://github.com/rbenv/ruby-build.git "$(rbenv root)"/plugins/ruby-build

# Ruby 3.3のインストール（数分かかります）
rbenv install 3.3.0
rbenv global 3.3.0

# 確認
ruby --version
```

【注意】
- `source ~/.bashrc` は現在のシェルに設定を反映するコマンド
- 新しいターミナルを開けば自動的に設定が読み込まれる
- Rails 8.0にはRuby 3.3以上が推奨されています

■ 4-4. Node.jsとyarnのインストール

```bash
# Node.js（NodeSourceを使用）
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# yarn
npm install -g yarn
```

■ 4-5. 既存プロジェクトのクローン（Aruaru Arenaの場合）

Aruaru Arenaプロジェクトをクローンして開発を開始する場合：

```bash
# プロジェクトをクローン
git clone https://github.com/your-username/aruaruarena.git
cd aruaruarena

# 依存関係のインストール
bundle install

# Node.jsパッケージのインストール（必要な場合）
yarn install
```

【既にWindowsにプロジェクトがある場合】

Windowsのファイルシステム上にプロジェクトが既にある場合：

```bash
# プロジェクトディレクトリへ移動（WindowsのパスからWSLのパスへ変換）
cd /mnt/c/Users/YourName/path/to/aruaruarena

# 依存関係のインストール
bundle install
```

■ 4-6. 新規プロジェクトの作成（参考）

新しくRailsプロジェクトを作成する場合の参考手順です：

```bash
# Railsプロジェクトの作成（APIモード、DynamoDB使用）
rails new my-rails-app --api --skip-active-record

# ※ --skip-active-record: Aruaru ArenaではDynamoDBを使用するためActive Recordをスキップ
# ※ AWS SDK for Ruby v3を後で追加

# プロジェクトディレクトリへ移動
cd my-rails-app

# GemfileにAWS SDK for Ruby v3を追加
echo "gem 'aws-sdk-dynamodb'" >> Gemfile
echo "gem 'aws-sdk-core', '~> 3'" >> Gemfile

# 依存関係のインストール
bundle install

# Gitリポジトリの初期化
git init
git add .
git commit -m "chore: initial commit"

# GitHubでリポジトリを作成後、リモートを追加
git remote add origin https://github.com/your-username/my-rails-app.git
git push -u origin main
```

【重要な注意点】

**Active Recordをスキップする理由**

通常のRails開発では、Active Record（データベース操作ライブラリ）を使用してMySQLやPostgreSQLなどのRDBMSにアクセスします。しかし、Aruaru Arenaでは以下の理由でActive Recordを使用しません：

1. **DynamoDBはNoSQL**: RDBMSと異なり、SQLではなくAWS SDKで直接アクセスする
2. **柔軟なデータ構造**: スキーマレスな設計が可能
3. **スケーラビリティ**: 大量のデータを高速に処理できる

【設定のまとめ】
- `--skip-active-record` オプションでActive Recordを除外
- データベース操作はAWS SDK for Ruby v3を使用して直接行います
- PostgreSQLなどのRDBMSは使用しません

【Aruaru Arenaの場合】
既にプロジェクトが存在するため、この手順は不要です。「3-5. 既存プロジェクトのクローン」を使用してください。

■ 4-7. 環境変数の設定

【環境変数とは？】
アプリケーションの設定値（APIキー、データベース接続情報など）を管理する仕組み。
- `.env.example`: テンプレート（Gitにコミットされる）
- `.env`: 実際の設定（Gitにコミットしない、機密情報）

【.envファイルの作成手順】

方法1：コマンドで作成

```bash
# .env.exampleをコピー
cp .env.example .env

# VSCodeで編集
code .env
```

方法2：直接作成

```bash
# .envファイルを作成
nano .env
# または
vim .env
```

【.envファイルの内容】

.env.example を参考に .env を作成：

```bash
# DynamoDB
# ※ DynamoDB Localの場合はダミーでOK
AWS_ACCESS_KEY_ID=dummy
AWS_SECRET_ACCESS_KEY=dummy
AWS_REGION=ap-northeast-1

# AI APIs
# ※ 各APIサービスから取得したキーを入力
GEMINI_API_KEY=your_gemini_api_key_here
GLM_API_KEY=your_glm_api_key_here
OPENAI_API_KEY=your_openai_api_key_here
```

【重要】
- APIキーは各サービスのWebサイトから取得してください
- `.env` ファイルはGitにコミットされません（`.gitignore`に設定済み）
- `.env` ファイルを絶対にGitHubに公開しないでください

WindowsのVSCodeからWSL2内のファイルを編集可能です。

■ 4-8. データベースセットアップ（DynamoDB Local）

```bash
# DynamoDB Localの起動（docker-compose使用）
docker-compose up -d dynamodb-local

# テーブル作成
bundle exec rails db:create_tables
```

■ 4-9. テスト環境の準備

```bash
bundle exec rspec
```

【開発ワークフロー（Windows 11 + WSL2）】

コマンド実行: WSL2のUbuntuターミナル
ファイル編集: VSCode（WSL拡張機能使用）

VSCodeからWSL2環境にアクセス：
1. 「WSL」拡張機能をインストール
2. 左下の「><」アイコン →「WSL: New Window」でWSL環境を開く

■ 4-10. Gitの設定（WSL2内）

```bash
# Git設定
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# 設定確認
git config --global --list

# ブランチ名をmainに統一
git config --global init.defaultBranch main
```

■ 4-11. GitHub CLI (gh) のインストールと認証

```bash
# GitHub CLIのインストール
curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
sudo apt update
sudo apt install gh

# 認証
gh auth login

# 対話的な認証手順：
# 1. GitHub.com を選択
# 2. HTTPS を選択
# 3. Login with a web browser を選択
# 4. 表示されたコードを入力

# 確認
gh auth status
```

================================================================================
5. CodeRabbitのセットアップ
================================================================================

CodeRabbitはAIコードレビューツールです。3つの方法で使用できます：
1. GitHub App（PR自動レビュー）
2. VSCode拡張機能（リアルタイムレビュー）
3. CLI（ローカルレビュー）

■ 5-1. GitHub Appのインストール（推奨）

1. https://coderabbit.ai にアクセス
2. 「Sign up with GitHub」をクリック
3. GitHubアカウントで認証

4. リポジトリの追加：
   - CodeRabbitダッシュボードで「Add Repositories」をクリック
   - 組織またはアカウント名を選択
   - 「Only select repositories」でAruaru Arenaリポジトリを選択
   - 「Install & Authorize」をクリック

【重要】
- Publicリポジトリは無料で利用可能です
- GitHub Appとしてインストールされると、PRが作成されると自動的にレビューが開始されます

■ 5-2. CLIのインストール（推奨）

WSL2のUbuntu内で実行：

```bash
# CodeRabbit CLIのインストール
curl -fsSL https://cli.coderabbit.ai/install.sh | sh

# シェルの再起動
source ~/.bashrc

# インストール確認
coderabbit --version

# 【必須】WSL2での認証情報永続化設定（libsecret + gnome-keyring）
# 1. 必要なパッケージのインストール
sudo apt-get update && sudo apt-get install -y gnome-keyring libsecret-1-0 libsecret-1-dev dbus-x11

# 2. gnome-keyringの初期化（プロセスの重複を防ぎつつ起動）
killall gnome-keyring-daemon 2>/dev/null || true
eval $(dbus-launch --sh-syntax)
echo -n "" | gnome-keyring-daemon --unlock
eval $(gnome-keyring-daemon --start --components=pkcs11,secrets,ssh)
export SSH_AUTH_SOCK

# 3. 設定の永続化（.bashrcに追記）
# 以下の内容を ~/.bashrc の末尾に追加してください：
# ---
# if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
#     eval $(dbus-launch --sh-syntax)
# fi
# eval $(gnome-keyring-daemon --start --components=pkcs11,secrets,ssh)
# export SSH_AUTH_SOCK
# ---

# 4. 認証の実行
coderabbit auth login

# ブラウザが開き、CodeRabbitにログイン
# 認証確認（成功していればLogged inと表示されます）
coderabbit auth status
```

【基本コマンド】

```bash
# インタラクティブモード
coderabbit

# プレーンテキストモード（詳細なフィードバック）
coderabbit --plain

# 未コミットの変更のみレビュー
coderabbit --type uncommitted

# ベースブランチを指定
coderabbit --base main
```

■ 5-3. Claude Codeプラグインのインストール

Claude Code内で実行：

```
/plugin install coderabbit
```

【確認】

```
/plugin list
```

`coderabbit` が表示されればインストール成功です。

【使い方】

```
/coderabbit:review                    # すべての変更をレビュー
/coderabbit:review uncommitted        # 未コミットの変更のみ
/coderabbit:review --base main        # mainブランチと比較
```

または自然言語で：

```
未コミットの変更についてレビューして
セキュリティ上の問題をチェックして
```

■ 5-4. プロジェクト設定の確認

プロジェクトには既に `.coderabbit.yaml` が設定されています：
- 日本語でのレビュー
- プロジェクト固有のルール（CLAUDE.md準拠）
- N+1クエリ、セキュリティの重点チェック

================================================================================
6. Skillsの使用方法
================================================================================

Skillsは再利用可能なワークフローをパッケージ化したものです。

■ 6-1. 利用可能なスキル

プロジェクトで使用可能なスキル：

| スキル名 | 説明 |
|---------|------|
| `todo-api-skill` | TODO管理APIの開発ワークフローを自動化。TDDサイクル（Red→Green→Refactor）でCRUD機能を実装 |
| `coderabbit:review` | CodeRabbit AIコードレビューを実行 |

■ 6-2. スキルの使用方法

Claude Code内で自然言語を使用すると、適切なスキルが自動的にトリガーされます。

【todo-api-skillのトリガー例】

```
TODO機能を追加して
タスク管理APIを実装して
投稿APIを作成して
```

【coderabbit:reviewのトリガー例】

```
コードレビューして
変更点をレビューして
```

または、明示的にスキルを指定：

```
/todo-api-skill
/coderabbit:review
```

■ 6-3. スキルの確認

```
/skills
```

で利用可能なスキル一覧が表示されます。

================================================================================
7. テスト環境構築（E01）の進捗
================================================================================

**概要**: RSpecを使用したテスト環境のセットアップ

**進捗状況**:
- [x] E01-01: RSpecの設定（spec/spec_helper.rb）
- [~] E01-02: FactoryBotの設定（spec/factories/）
  - ✅ spec/support/factory_bot.rbは作成済み
  - ❌ spec/factories/ディレクトリが未作成
- [ ] E01-03: SimpleCovの設定（カバレッジ90%以上）
- [ ] E01-04: VCR（API Mocking）の設定
- [ ] E01-05: DynamoDB Localとの連携（spec/support/dynamoid.rb）
- [x] E01-06: RuboCopの設定（.rubocop.yml）
- [x] E01-07: Brakemanの設定（セキュリティスキャン）
  - ✅ Gemfileに含まれている
  - ✅ 設定ファイル不要（コマンドラインツール）

**受入基準**:
- `bundle exec rspec` でテスト実行可能
- `COVERAGE=true bundle exec rspec` でカバレッジレポート生成
- VCRでAI APIのモックが可能
- DynamoDB Localでテスト用テーブルが自動作成

**関連ファイル**:
- `spec/spec_helper.rb`
- `spec/rails_helper.rb`
- `spec/support/factory_bot.rb`
- `spec/support/vcr.rb`
- `.rubocop.yml`
- `.simplecov`

**次のステップ**:
1. SimpleCovの設定ファイル `.simplecov` を作成
2. VCRの設定ファイル `spec/support/vcr.rb` を作成
3. DynamoDB Localとの連携設定 `spec/support/dynamoid.rb` を作成
4. `spec/factories/` ディレクトリを作成し、ファクトリファイルを追加

================================================================================
8. インフラ構築（AWS / Terraform）
================================================================================

**概要**: AWSインフラの構築（Terraform）

**構成**:
- Lambda（Dockerコンテナ）
- DynamoDB（4テーブル）
- API Gateway（HTTP API）
- S3（静的ホスティング）
- CloudFront（CDN + OGPキャッシュ）
- EventBridge（ウォームアップ）

**進捗状況**:
- [x] E02-01: Terraform設定の実装
- [x] E02-02: Lambda関数のデプロイ
- [x] E02-03: DynamoDBテーブルの作成
- [x] E02-04: API Gatewayの設定
- [x] E02-05: S3 + CloudFrontの設定（S3のみ完了）
- [ ] E02-06: EventBridgeの設定
- [ ] E02-07: GitHub Actions（CI/CD）の実装

**受入基準**:
- 月額コスト: $0.26/月（AWS）+ $2.25/月（AI）
- CloudWatchアラート設定
- PITR（Point-In-Time Recovery）有効化

**関連ファイル**:
- `backend/terraform/provider.tf`
- `backend/terraform/variables.tf`
- `backend/terraform/outputs.tf`

================================================================================
9. 開発ワークフロー
================================================================================

■ ステップ1：機能仕様の確認

1. GitHub Issue を確認
2. 仕様から以下を抽出：
   - エンドポイント定義
   - データモデル（DynamoDBテーブル）
   - 受入基準
   - API仕様（docs/epics.md）

■ ステップ2：Plan Mode で設計

# プランモードの起動（WSL2内）
claude

# Plan Modeへの切り替え（Windows 11 + VSCode）
# VSCodeで: ALT + M

# ※ WSL2ターミナルの場合
# 起動時に claude --plan-mode でもPlan Modeで起動可能

Claude Codeに以下を依頼：

────────────────────────────────────────────────────────────────
GitHub Issue #XX の仕様を読んでください。

この機能を実装するための計画を立ててください：
1. 必要なファイルとその役割
2. DynamoDBテーブル設計（PK/SK/GSI）
3. エンドポイントの設計
4. テストケースのリスト（正常系・異常系・エッジケース）
5. レート制限・セキュリティ上の注意点

CLAUDE.md のルールを遵守してください。
────────────────────────────────────────────────────────────────

設計を SCRATCHPAD.md に保存してもらいます。

■ ステップ3：TDDで実装

【通常モードに切り替え】
# Windows 11 + VSCode: ALT + M
# WSL2ターミナル: 起動オプションなしで claude 実行

【Red：テストを先に書く】

【Redとは？】
テストを先に書き、まだ実装していないので失敗（Red）することを確認します。
- なぜ先に書くのか：仕様を明確にする、後でテストを書き忘れるのを防ぐ
- 失敗を確認：テストが正しく動いていることを確認する意味もある

────────────────────────────────────────────────────────────────
spec/requests/api/posts_spec.rb にテストコードを作成してください。
Issue #XX の受入基準をすべてカバーしてください。
CLAUDE.md の禁止事項に違反しないように注意してください。
────────────────────────────────────────────────────────────────

テストを実行して失敗を確認：
```bash
bundle exec rspec
```

実行結果に「Failed examples」が表示されれば成功（テストが正しく書かれている証拠）。

【Green：実装】

【Greenとは？】
テストを通るように実装します。すべてのテストが成功（Green）することを目指します。
- 最小限の実装：まずはテストを通すだけの実装でOK
- 完璧である必要はない：リファクタリングで後で整える

────────────────────────────────────────────────────────────────
テストが通るように実装してください。
CLAUDE.md のルールを守ること：
- .permit! 禁止
- N+1クエリ対策
- トランザクションの使用
- エラーフォーマット: { error: "...", code: "..." }
────────────────────────────────────────────────────────────────

テストを実行して成功を確認：
```bash
bundle exec rspec
```

実行結果に「0 failures」が表示されれば成功（すべてのテストが通った証拠）。

【Refactor：リファクタリング】

【Refactorとは？】
コードの動作を変えずに、内部構造を改善すること。
- なぜやるのか：コードの可読性向上、重複の排除、保守性向上
- いつやるのか：テストが通った後（安全に変更できるため）

必要に応じてリファクタリング：
- Service Objectへの切り出し（ビジネスロジックを分離）
- コードの簡潔化（重複を排除、メソッド抽出）
- パフォーマンス最適化（N+1クエリ解消など）

【重要】
- リファクタリング後、必ずテストを再実行してGreenを維持してください
```bash
bundle exec rspec
```

■ ステップ4：品質チェック

# Lint（自動修正）
bundle exec rubocop -A

# セキュリティスキャン
bundle exec brakeman -q

# カバレッジレポート
COVERAGE=true bundle exec rspec

# CodeRabbitレビュー
/coderabbit:review

または自然言語で：
未コミットの変更についてレビューして

■ ステップ5：コミット・Push・PR作成

【ブランチ命名規則】

```
feat/<Issue番号>-<機能名>
例: feat/12-post-api
例: feat/15-judge-service
例: fix/21-rate-limiter-bug
```

【コミットメッセージルール】

CLAUDE.mdのルールに従い、「type: 日本語」形式を使用します。

【コミットメッセージの例】

```
feat: 投稿APIを実装

- POST /api/posts エンドポイントを追加
- 投稿バリデーションをモデルに実装
- レート制限を適用
- RSpecテストを追加

fix #12
```

```
fix: 審査ステータス更新時のトランザクション不備を修正

- JudgePostServiceにトランザクションを追加
- 審査失敗時のロールバックを确保
- テストケースを追加

fix #25
```

```
refactor: 投稿一覧取得のN+1クエリを解消

- includes(:user)で事前ロード
- パフォーマンスを改善（200ms→50ms）
```

【コミット・Push】

```bash
git add app/ spec/
git commit -m "feat: 投稿APIを実装

- POST /api/posts エンドポイントを追加
- 投稿バリデーションをモデルに実装
- レート制限を適用
- RSpecテストを追加

fix #12"
git push origin feat/12-post-api
```

【PRの作成】

方法1：gh CLIを使用（推奨）

```bash
gh pr create --title "feat: 投稿APIを実装 (fix #12)" --body "PRの説明"
```

方法2：GitHub Web UI

1. GitHubでリポジトリを開く
2. 「Compare & pull request」をクリック
3. PRタイトル：`feat: 投稿APIを実装 (fix #12)`
4. PR説明欄にテンプレートを使用して記述
5. 「Create pull request」

【PRテンプレート（推奨）】

```
## 概要
Issue #12 の投稿API実機能を実装しました。

## 変更内容
- POST /api/posts エンドポイントを追加
- 投稿バリデーションをモデルに実装
- レート制限を適用（IP/ニックネームごとに5分1回）
- RSpecテストを追加（正常系・異常系・境界値）

## テスト
- [x] RSpecテストが通過
- [x] RuboCop違反なし
- [x] Brakemanセキュリティチェック完了
- [x] カバレッジ90%以上
- [x] CodeRabbitレビュー対応済み

## チェックリスト
- [x] CLAUDE.mdのルールを遵守
- [x] .permit!を使用していない
- [x] N+1クエリ対策済み
- [x] トランザクション適切に使用
- [x] 機密情報のハードコードなし

## 関連Issue
fix #12
```

■ ステップ6：CodeRabbit自動レビューと対応

CodeRabbit（GitHub App）が自動レビュー開始：
- Summary：変更の概要
- Issues：検出された問題
- Suggestions：改善提案
- Security findings：セキュリティ脆弱性

指摘に対応：
git add .
git commit -m "fix: CodeRabbitのフィードバックに対応"
git push

■ ステップ7：テスト通過後にマージ

GitHub Actionsですべてのテストが緑になったら：
GitHubのUIで「Merge pull request」

================================================================================
10. 実装順序の推奨（フェーズ0〜5）
================================================================================

**重要**: TDD（テスト駆動開発）を実践するため、E01（テスト環境構築）を最優先で実施してください。

### フェーズ0: 環境セットアップ（全体）
1. **E01: テスト環境構築**（RSpec/FactoryBot/SimpleCov/VCR）- **最優先**
2. **E02: インフラ構築**（ローカルはDocker、AWSはTerraform）
3. **E03: DynamoDBスキーマ定義**（4テーブル設計・実装）
4. **E04: フロントエンド基盤構築**（並列実装可・バックエンド完了待たず）

### フェーズ1: 投稿・審査の基本フロー
5. **E05: 投稿API**（Thread方式で非同期審査をトリガー）
6. **E06: AI審査システム**（3人並列実行）
7. **E07: 投稿詳細API**（審査結果結合）

### フェーズ2: ランキング・公開
8. **E08: ランキングAPI**（TOP20取得）
9. **E09: レート制限・スパム対策**（5分制限・重複チェック）
10. **E10: OGP画像生成**（SNSシェア用）

### フェーズ3: 再審査・高度な機能
11. **E11: 再審査API**（失敗審査員のみ再実行）

### フェーズ4: フロントエンド実装
12. **E12: トップ画面**（モック使用で先行開発可）
13. **E13: 審査中画面**（モック使用で先行開発可）
14. **E14: 審査結果モーダル**（モック使用で先行開発可）

### フェーズ5: 追加機能
15. **E15: 自分の投稿一覧**
16. **E16: プライバシーポリシー**
17. **E17: BGM・SE再生**

**詳細なEpic仕様**: `docs/epics.md` を参照してください。

================================================================================
11. トラブルシューティング
================================================================================

【Q1. DynamoDB Localが起動しない】

確認：
    docker ps

解決策：
    docker-compose down
    docker-compose up -d dynamodb-local

【Q2. RSpecでN+1検出エラー】

Bullet gemが検出：

解決策：
includes / preload / eager_load を使用

例：
```ruby
# Bad
Post.all.each { |post| post.user.name }

# Good
Post.includes(:user).each { |post| post.user.name }
```

【Q3. Strong Parameters違反】

CodeRabbitが検出：

解決策：
.permit! を使用せず、明示的に指定

例：
```ruby
# Bad
params.permit!

# Good
params.permit(:title, :content, :nickname)
```

【Q4. レート制限の実装】

解決策：
RedisまたはDynamoDBでカウント管理

例：
```ruby
# app/services/rate_limiter_service.rb
class RateLimiterService
  def self.allowed?(ip_address, nickname)
    # 5分1回の制限チェック
  end
end
```

【Q5. AI APIのエラーハンドリング】

解決策：
Service Objectで適切に例外処理

例：
```ruby
# app/services/judge_post_service.rb
class JudgePostService
  def call
    # AI API呼び出し
    # エラー時は適切な例外を送出
  rescue StandardError => e
    Rails.logger.error("AI審査エラー: #{e.message}")
    raise AiJudgeError, "審査中にエラーが発生しました"
  end
end
```

【Q6. CodeRabbitがPRをレビューしない】

確認：
1. https://github.com/settings/installations でCodeRabbit Appを確認
2. リポジトリアクセス権限を確認

【Q7. コンテキストが溢れて混乱】

解決策：
Claude Codeで：
    /compact  # 要約取得
    /clear    # 完全リセット
    # 新しい会話でSCRATCHPAD.mdをペースト

【Q8. WSL2でDockerが動作しない】

確認：
    docker --version
    docker ps

解決策1：Docker DesktopのWSL統合を確認
1. Docker Desktop → Settings → Resources → WSL Integration
2. 「Enable integration with my default WSL distro」をオン
3. 該当するディストリビューションにチェック

解決策2：Dockerサービスの再起動
```powershell
# PowerShell（管理者）
wsl --shutdown
# Docker Desktopを再起動
```

【Q9. VSCodeからWSL2のファイルが見えない】

解決策：
1. VSCodeの「WSL」拡張機能をインストール
2. 左下の「><」アイコン →「WSL: New Window」
3. または、WSLターミナルから `code .` でVSCodeを起動

【Q10. WindowsのパスとWSL2のパスの違い】

Windowsパス: C:\Users\YourName\path\to\project
WSL2パス:   /mnt/c/Users/YourName/path/to/project

変換方法：
```bash
# WSL2からWindowsパスを参照
cd /mnt/c/Users/YourName/path/to/project

# WindowsからWSL2パスを参照
\\wsl.localhost\Ubuntu\home\user\path\to\project
```

【Q11. bundle install でネイティブ拡張のエラー】

解決策：
```bash
# 必要な開発ツールをインストール
sudo apt update
sudo apt install -y build-essential libyaml-dev libreadline-dev libssl-dev zlib1g-dev

# 再度インストール
bundle install
```

【Q12. Plan Mode (ALT+M) が反応しない】

確認：
1. VSCodeがフォーカスされているか
2. キーボードショートカットの設定を確認

解決策：
コマンドパレット（Ctrl+Shift+P）から「Claude Code: Toggle Plan Mode」を実行

または、WSL2ターミナルから：
```bash
claude --plan-mode
```

【Q13. AI APIがタイムアウトする】

現象：
- 審査中にタイムアウトエラーが発生
- `Net::ReadTimeout` または `Faraday::TimeoutError`

確認：
```bash
# Railsログで確認
tail -f log/development.log
```

解決策1：タイムアウト設定を延長

```ruby
# app/services/judge_post_service.rb
class JudgePostService
  def initialize
    @timeout = 30 # 30秒に延長
  end
end
```

解決策2：非同期処理の検討
- Sidekiq等のジョブキューを使用
- Active Jobでバックグラウンド処理

【Q14. AI APIのレート制限エラー】

現象：
- `429 Too Many Requests`
- `rate_limit_exceeded` エラー

解決策1：指数バックオフ実装

```ruby
# app/services/judge_post_service.rb
def call_with_retry(max_attempts: 3)
  attempt = 0
  begin
    attempt += 1
    call
  rescue StandardError => e
    if attempt < max_attempts
      sleep(2 ** attempt) # 指数的バックオフ
      retry
    else
      raise
    end
  end
end
```

解決策2：キューの使用
- 複数のAI APIを順番に呼び出すのではなく、並列処理を検討

【Q15. 審査ステータスが更新されない】

現象：
- 投稿後もステータスが `judging` のまま
- `scored` または `failed` に遷移しない

確認：
```bash
# Railsコンソールで確認
rails c
post = Post.last
post.status
```

解決策1：JudgePostServiceが正常に呼び出されているか確認

```ruby
# ログを確認
Rails.logger.info "Starting judge for post #{post.id}"
```

解決策2：例外処理でステータス更新が失敗していないか確認

```ruby
# app/services/judge_post_service.rb
rescue StandardError => e
  Rails.logger.error "Judge failed: #{e.message}"
  # ステータスをfailedに更新
  post.update!(status: 'failed')
  raise
end
```

【Q16. DynamoDBテーブルが作成されない】

現象：
- `Aws::DynamoDB::Errors::ResourceNotFoundException`
- テーブルが見つからないエラー

確認：
```bash
# DynamoDB Localのテーブル一覧
aws dynamodb list-tables \
  --endpoint-url http://localhost:8000 \
  --region ap-northeast-1
```

解決策1：テーブル作成スクリプトを実行

```bash
bundle exec rails db:create_tables
```

解決策2：手動でテーブル作成（DynamoDB Local）

```bash
aws dynamodb create-table \
  --table-name Posts \
  --attribute-definitions \
    AttributeName=pk,AttributeType=S \
    AttributeName=sk,AttributeType=S \
  --key-schema \
    AttributeName=pk,KeyType=HASH \
    AttributeName=sk,KeyType=RANGE \
  --billing-mode PAY_PER_REQUEST \
  --endpoint-url http://localhost:8000 \
  --region ap-northeast-1
```

【Q17. DynamoDB Localのデータが消える】

現象：
- Dockerコンテナを再起動するとデータが消える

解決策：
データの永続化設定を追加

```yaml
# docker-compose.yml
services:
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    volumes:
      - dynamodb-data:/home/dynamodblocal/data
    # ...他の設定

volumes:
  dynamodb-data:
```

【Q18. レート制限が正しく動作しない】

現象：
- 5分以内に連続投稿できてしまう

解決策1：Redisを導入

```bash
# docker-compose.ymlにRedisを追加
services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
```

解決策2：DynamoDBでカウント管理

```ruby
# app/services/rate_limiter_service.rb
class RateLimiterService
  TABLE_NAME = 'RateLimits'.freeze

  def self.allowed?(ip_address, nickname)
    key = "rate_limit:#{ip_address}:#{nickname}"
    now = Time.now.to_i
    five_minutes_ago = now - 300

    # 過去5分の投稿数を取得
    client = Aws::DynamoDB::Client.new
    response = client.query({
      table_name: TABLE_NAME,
      key_condition_expression: 'pk = :pk AND sk >= :sk',
      expression_attribute_values: {
        ':pk' => key,
        ':sk' => five_minutes_ago.to_s
      }
    })

    response.items.count.zero?
  end
end
```

【Q19. GitHub Actionsのテストが失敗する】

現象：
- ローカルでは通るが、CIで失敗する

確認：
1. GitHub Actionsのログを確認
2. 環境変数の設定を確認（Settings → Secrets and variables → Actions）

解決策1：環境変数の設定

```yaml
# .github/workflows/test.yml
env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
```

解決策2：DynamoDB Localの起動を待機

```yaml
- name: Wait for DynamoDB Local
  run: |
    until curl -sS http://localhost:8000 > /dev/null; do
      echo "Waiting for DynamoDB Local..."
      sleep 1
    done
```

【Q20. DynamoDB Localのhealthcheckが失敗する】

現象：
- `docker compose up -d`実行時、"unhealthy"エラーが発生
- Container status shows "unhealthy"
- Error: "dependency failed to start: container is unhealthy"

原因：
- DynamoDB Localコンテナにcurlコマンドがインストールされていない
- healthcheckでcurlを使用しているが、amazon/dynamodb-localイメージにはcurlが含まれていない

確認：
```bash
# コンテナのステータス確認
docker ps -a

# ログ確認
docker logs aruaruarena-dynamodb
```

解決策：docker-compose.ymlからhealthcheckセクションを削除

```yaml
# 削除するセクション（docker-compose.yml）：
# healthcheck:
#   test: ["CMD-SHELL", "curl -f http://localhost:8000 || exit 1"]
#   interval: 5s
#   timeout: 5s
#   retries: 5
#   start_period: 10s
```

コンテナの再起動：
```bash
# コンテナ停止・削除
docker compose down

# 再起動
docker compose up -d

# ステータス確認（STATUSが"Up"であることを確認）
docker ps
```

備考：
- healthcheckは必須ではないので、削除しても問題ありません
- DynamoDB Local自体は正常に動作しています
- GUI (http://localhost:8001) でテーブル確認可能
- コンテナが"Up"状態であれば、開発に支障はありません

================================================================================
12. プロダクション品質チェックリスト
================================================================================

【事前準備】
- [ ] 環境変数の設定（.env）
- [ ] DynamoDB Localの起動
- [ ] 依存関係のインストール（bundle install）

【仕様・設計フェーズ】
- [ ] GitHub Issue の仕様を確認
- [ ] Claude Code で Plan Mode に入る
- [ ] 設計を SCRATCHPAD.md に保存
- [ ] DynamoDBテーブル設計（PK/SK/GSI）

【実装フェーズ】
- [ ] ブランチを切る（feat/<Issue番号>-<機能名>）
- [ ] テストコードを先に書く（Red）
- [ ] 実装コードを書く（Green）
- [ ] 必要に応じてリファクタリング

【品質チェック】
- [ ] RSpecテストが通る（bundle exec rspec）
- [ ] RuboCop違反ゼロ（bundle exec rubocop -A）
- [ ] Brakemanセキュリティチェック（bundle exec brakeman -q）
- [ ] カバレッジ90%以上（COVERAGE=true bundle exec rspec）
- [ ] CodeRabbitレビュー（/coderabbit:review）

【禁止事項のチェック】
- [ ] .permit! を使用していない
- [ ] N+1クエリの対策済み
- [ ] トランザクションを適切に使用
- [ ] 機密情報のハードコードなし
- [ ] binding.pry が残っていない

【統合・デプロイ】
- [ ] コミット（fix #<Issue番号>）
- [ ] Push → PR作成
- [ ] CodeRabbit自動レビュー対応
- [ ] GitHub Actionsでテスト通過
- [ ] マージ → Issue自動クローズ

================================================================================
禁止事項・必須ルール（CLAUDE.mdより）
================================================================================

🚫 絶対禁止事項

1. **`.permit!`** の使用 → 必ず `.permit(:attr1, :attr2)` を明示
2. **N+1クエリ** → `includes` / `preload` / `eager_load` を使用
3. **トランザクションなし** で複数DB操作
4. **ハードコード** された機密情報（APIキー、パスワード）
5. **テストなし** で機能を実装
6. **`binding.pry`** を本番コードに残す
7. **日本語以外** でコメント・コミットメッセージを書く

✅ 必須コーディングルール

### モデル
- すべてのバリデーションはモデルレイヤーで実装
- アソシエーションには `dependent:` オプションを明示

### コントローラー
- RESTful 7アクション遵守
- 1メソッド15行以内
- 統一エラーフォーマット: `{ error: "...", code: "..." }`

### サービスオブジェクト
- 配置: `app/services/`
- 命名: 動詞 + 名詞 + Service（例: `CreatePostService`）

### テスト（TDD必須）
- Red → Green → Refactor サイクル
- `describe`, `context`, `it` で構造化
- カバレッジ90%以上（SimpleCov）

================================================================================
主要コマンド
================================================================================

# サーバー起動
bundle exec rails server

# コンソール
bundle exec rails console

# テスト
bundle exec rspec

# カバレッジレポート
COVERAGE=true bundle exec rspec

# Lint
bundle exec rubocop -A

# セキュリティスキャン
bundle exec brakeman -q

# DynamoDB Local
docker compose up -d

# GitHub PR作成
gh pr create --title "feat: タイトル" --body "説明"

# CodeRabbitレビュー
coderabbit --plain

================================================================================
13. 付録：プロジェクト設定ファイル
================================================================================

■ docker-compose.yml

DynamoDB Localの起動設定（開発用・テスト用・GUI管理ツールの3つのコンテナ）：

```yaml
services:
  # ----------------------------------------------------------------------------
  # 🛠️ 開発用 DynamoDB (永続化あり)
  # Port: 8000
  # ----------------------------------------------------------------------------
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: aruaruarena-dynamodb
    ports:
      - "8000:8000"
    volumes:
      - dynamodb-data:/home/dynamodblocal/data
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath ./data"

  # ----------------------------------------------------------------------------
  # 🧪 テスト用 DynamoDB (インメモリ・高速)
  # Port: 8002
  # ----------------------------------------------------------------------------
  dynamodb-test:
    image: amazon/dynamodb-local:latest
    container_name: aruaruarena-dynamodb-test
    ports:
      - "8002:8000"
    command: "-jar DynamoDBLocal.jar -inMemory -sharedDb"

  # ----------------------------------------------------------------------------
  # 👁️ DynamoDB GUI Admin
  # URL: http://localhost:8001
  # ----------------------------------------------------------------------------
  dynamodb-admin:
    image: aaronshaf/dynamodb-admin
    container_name: aruaruarena-dynamodb-admin
    ports:
      - "8001:8001"
    environment:
      DYNAMO_ENDPOINT: "http://dynamodb-local:8000"
      AWS_REGION: "ap-northeast-1"
      AWS_ACCESS_KEY_ID: "local"
      AWS_SECRET_ACCESS_KEY: "local"

volumes:
  dynamodb-data:
```

【起動方法】

```bash
docker compose up -d
```

【確認方法】

```bash
# コンテナのステータス確認
docker ps

# テーブル一覧（AWS CLI）
aws dynamodb list-tables \
  --endpoint-url http://localhost:8000 \
  --region ap-northeast-1

# GUIで確認（ブラウザでアクセス）
open http://localhost:8001  # macOS
# Windowsの場合はブラウザで直接 http://localhost:8001 にアクセス
```

【重要：healthcheck設定について】

DynamoDB Localコンテナにはcurlが含まれていないため、healthcheckセクションを追加すると"unhealthy"エラーが発生します。healthcheckは必須ではないため、含めないでください。（詳細はQ20を参照）

【コンテナの用途】

| コンテナ | ポート | 用途 | データ永続化 |
|---------|--------|------|-------------|
| dynamodb-local | 8000 | 開発用 | あり |
| dynamodb-test | 8002 | テスト用 | なし（インメモリ） |
| dynamodb-admin | 8001 | GUI管理ツール | - |

■ .env.example

環境変数のテンプレート：

```bash
# DynamoDB
AWS_ACCESS_KEY_ID=dummy
AWS_SECRET_ACCESS_KEY=dummy
AWS_REGION=ap-northeast-1
DYNAMODB_ENDPOINT=http://localhost:8000

# AI APIs
GEMINI_API_KEY=your_gemini_api_key_here
GLM_API_KEY=your_glm_api_key_here
OPENAI_API_KEY=your_openai_api_key_here

# Rails
RAILS_ENV=development
SECRET_KEY_BASE=your_secret_key_base_here
```

【使用方法】

```bash
# .env.exampleをコピーして.envを作成
cp .env.example .env

# エディタで.envを編集
code .env
```

【重要】
- .envファイルは.gitignoreに含まれているため、Gitコミットされません
- APIキー等の機密情報は.envにのみ記載してください

■ .coderabbit.yaml

CodeRabbitの設定（プロジェクトに既に設定済み）：

主な設定内容：
- 日本語でのレビュー
- プロジェクト固有のルール（CLAUDE.md準拠）
- N+1クエリ、セキュリティの重点チェック
- パスフィルタ（vendor/, node_modules/等を除外）
- 知識ベース（docs/, CLAUDE.md等を参照）

【確認方法】

```bash
# 設定ファイルを確認
cat .coderabbit.yaml

# CodeRabbitダッシュボードで確認
https://coderabbit.ai/dashboard
```

■ .github/workflows/test.yml

GitHub Actionsのテストワークフロー：

```yaml
name: Run Tests

on:
  push:
    branches: [main, dev, "feat/**"]
  pull_request:
    branches: [main, dev]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3
          bundler-cache: true

      - name: Start DynamoDB Local
        run: docker compose up -d dynamodb-local

      - name: Wait for DynamoDB Local
        run: |
          until curl -sS http://localhost:8000 > /dev/null; do
            echo "Waiting for DynamoDB Local..."
            sleep 1
          done

      - name: Run RSpec
        run: bundle exec rspec

      - name: Run RuboCop
        run: bundle exec rubocop

      - name: Check test coverage
        run: |
          coverage=$(cat coverage/.last_run.json | jq '.result.line')
          if [ $(echo "$coverage < 90" | bc) -eq 1 ]; then
            echo "❌ Test coverage is below 90%: $coverage%"
            exit 1
          fi
```

================================================================================
14. 用語集
================================================================================

このセクションでは、手順書で出てくる用語の説明をします。

【開発環境】

**WSL2 (Windows Subsystem for Linux 2)**
Windows上でLinuxを動かす仕組み。WindowsとLinuxのファイルシステムを相互にアクセスできる。
- なぜ使うのか：Ruby/Railsの開発はLinux環境が標準的
- パス変換：`C:\Users\...` → `/mnt/c/Users/...`

**Docker**
コンテナ技術。アプリケーションと環境を一緒にパッケージ化する。
- DynamoDB Local：Dockerコンテナで動くDynamoDBの開発版

**PowerShell**
Windowsのコマンドラインツール。管理者権限で実行する必要があるコマンドがある。
- 管理者権限で開く：スタートメニューで「PowerShell」を右クリック →「管理者として実行」

【GitとGitHub】

**Git**
バージョン管理システム。ファイルの変更履歴を管理する。
- `git add`: 変更をステージングに追加
- `git commit`: 変更をコミット（保存）
- `git push`: リモートリポジトリに送信
- `git pull`: リモートリポジトリから取得

**GitHub**
GitリポジトリをホスティングするWebサービス。コードの共有、PR、Issue管理などができる。

**ブランチ (Branch)**
作業用の分岐。メインの開発に影響を与えずに機能開発ができる。
- `main`: メインブランチ（本番環境）
- `feat/XX-feature`: 機能開発用ブランチ
- `fix/XX-bug`: バグ修正用ブランチ

**PR (Pull Request)**
ブランチの変更をメインブランチにマージするリクエスト。コードレビューの場でもある。

**コミットメッセージ**
コミット時に付ける変更の説明。`type: 日本語`形式を使用する。
- `feat`: 新機能
- `fix`: バグ修正
- `refactor`: リファクタリング

【RailsとRuby】

**Ruby**
プログラミング言語。RailsはRubyで書かれている。

**Rails (Ruby on Rails)**
RubyのWebアプリケーションフレームワーク。規約約重視で効率的な開発が可能。

**APIモード**
Railsの設定で、ビュー（HTML生成）機能を省いたモード。APIサーバー構築に適している。

**Active Record**
Railsのデータベース操作ライブラリ。Aruaru ArenaではDynamoDBを使用するため、スキップしている。

【DynamoDB】

**DynamoDB**
AmazonのNoSQLデータベースサービス。キーバリューストアで高速なアクセスが可能。

**PK/SK/GSI**
DynamoDBのテーブル設計用語：
- **PK (Primary Key)**: パーティションキー。データの分散に使用
- **SK (Sort Key)**: ソートキー。同じPK内でのソートに使用
- **GSI (Global Secondary Index)**: グローバルセカンダリインデックス。別の検索キー

**DynamoDB Local**
ローカル環境で動くDynamoDB。開発・テスト用に使用する。

【テスト】

**TDD (Test-Driven Development)**
テスト駆動開発。テストを先に書く開発手法。
- Red: テストを書いて失敗することを確認
- Green: テストを通る実装を書く
- Refactor: コードを整理する

**RSpec**
Rubyのテストフレームワーク。`describe`, `context`, `it` で構造化する。

**FactoryBot**
テストデータを作成するライブラリ。

**SimpleCov**
Rubyのコードカバレッジツール。どの程度テストされているかを可視化する。

【品質保証】

**N+1クエリ**
データベースの非効率なアクセスパターン。ループの中でデータベースにアクセスすること。
- 対策: `includes`, `preload`, `eager_load` を使用

**Strong Parameters**
Railsのセキュリティ機能。許可したパラメータのみを通す。
- `.permit!` は禁止（すべてのパラメータを許可してしまうため）

**RuboCop**
Rubyのコーディング規約チェックツール。

**Brakeman**
Railsのセキュリティスキャンツール。

【コード設計】

**Service Object**
ビジネスロジックを担当するオブジェクト。`app/services/` に配置。
- 命名: 動詞 + 名詞 + Service（例: `CreatePostService`）
- メリット: コントローラーを薄く保てる、ロジックを再利用しやすい

**RESTful 7アクション**
Railsの標準的なアクション：
- `index`, `show`, `new`, `create`, `edit`, `update`, `destroy`

【AIと開発ツール】

**Claude Code**
AnthropicのAIコーディングアシスタント。Plan Modeで設計、通常モードで実装をサポート。

**Skills**
Claude Codeの再利用可能なワークフロー。

**CodeRabbit**
AIコードレビューツール。PRに対して自動レビューを行う。

**Plan Mode**
Claude Codeの設計モード。実装前に計画を立てるためのモード。

【その他】

**環境変数**
アプリケーションの設定値（APIキーなど）。`.env` ファイルで管理。
- `.env.example`: テンプレート
- `.env`: 実際の設定（Gitコミットしない）

**endpoint-url**
APIの接続先URL。DynamoDB Localの場合は `http://localhost:8000`

**Gem (Gem)**
Rubyのライブラリパッケージ。`Gemfile` で管理する。

**bundle**
Rubyのライブラリ管理ツール。`bundle install` でライブラリをインストール。

================================================================================
参考ドキュメント
================================================================================

| カテゴリ | 参照先 |
|---------|--------|
| 画面設計・UI/UX | docs/screen_design.md |
| DB設計 | docs/db_schema.md |
| Gem一覧 | Gemfile |
| APIエンドポイント | README.md または docs/epics.md |
| デザインシステム | docs/DESIGN_SYSTEM_*.md |
| プロジェクトルール | CLAUDE.md |

================================================================================
最後に
================================================================================

【継続的改善のサイクル】

失敗 → ログ確認 → CLAUDE.md/Skill/Learnings改善のフライホイールを回せ

1. 開発中にエラーや非効率なパターンを発見
2. それを記録
3. CLAUDE.md、Skill、またはCodeRabbit Learningsに反映
4. 次回から自動的に改善

【迷ったら】

1. Railsガイド（https://railsguides.jp/）を確認
2. docs/ ディレクトリの設計書を参照
3. 同じ修正を2回したら、CLAUDE.mdに追加

================================================================================

🚀 Happy Coding with Aruaru Arena! 🚀

最終更新: 2026年2月8日
バージョン: 1.4（Aruaru Arena向けカスタマイズ版・Windows 11対応・初学者向け改善版）
ライセンス: MIT

================================================================================
