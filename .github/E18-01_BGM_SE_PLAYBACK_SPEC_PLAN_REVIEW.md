```text
- [重要度: 高]
  問題点: BGMとSEの再生対象イベントが一部曖昧で、同一イベントで複数回再生される条件（例: React再レンダリング、モーダル再描画）が未定義。
  改善提案: 「シーン変更時のみBGM切替」「同一シーン再レンダリングでは再生しない」「SEはユーザー操作1回につき1回のみ再生」を明文化する。

- [重要度: 高]
  問題点: 自動再生制約への対応が抽象的で、いつ音声コンテキストを有効化するか不明確。
  改善提案: 初回のユーザー操作（クリック/タップ/キー操作）で `audioUnlocked=true` を確定し、それ以前は再生要求を無視する仕様を追加する。

- [重要度: 高]
  問題点: ミュート状態の保存フォーマットが未定義で、将来の互換性崩れや移行漏れが発生しうる。
  改善提案: `aruaru_sound_muted` は文字列 `'true' | 'false'` で保存し、未設定・不正値は `'true'` として扱う正規化ルールを定義する。

- [重要度: 中]
  問題点: クロスフェードの音量仕様が曖昧で、実装者ごとに開始/終了音量が分かれる。
  改善提案: フェード時間500ms、旧BGM `1.0 -> 0.0`、新BGM `0.0 -> 1.0`、線形補間を固定する。

- [重要度: 中]
  問題点: 非機能要件に「多重再生しない」はあるが判定方法がない。
  改善提案: 同時にループ再生されるBGMインスタンスは常に1つ以下と明記し、単体テストで `play` 呼び出し回数と `stop/unload` 呼び出しを検証する。

- [重要度: 中]
  問題点: 音声ファイル管理ルール（配置パス・対応フォーマット・命名）が未記載で、運用時に崩れやすい。
  改善提案: `frontend/public/audio/` 配下に配置し、`.mp3` を標準、必要に応じて `.ogg` 併記、IDとファイル名を1対1で管理する。

- [重要度: 中]
  問題点: ミュートON時の挙動が「再生しない」だけで、再生中BGM停止やフェード中断ルールが不足。
  改善提案: ミュートON時は再生中BGMを即時停止し、予約中SEを破棄、以後の再生要求を無視することを仕様化する。

- [重要度: 低]
  問題点: E2Eテストが実音再生依存だとCIで不安定になりやすい。
  改善提案: E2Eでは `window.__AUDIO_DEBUG__` などの計測用イベント配列を参照し、再生要求イベントで検証する方式を追記する。
```

## 修正版（完全版）

````markdown
# [SPEC] E18-01〜E18-06: BGM・SE再生

## 📋 概要
E18「BGM・SE再生」として、トップ画面・審査中画面・審査結果モーダルのシーンに応じてBGMとSEを再生する。Howler.jsを導入し、クロスフェード・ミュートトグル・永続化・自動再生制約対応を実装する。

## 🎯 目的
- 画面遷移と結果表示に合わせた音演出を追加し、体験価値を向上させる
- 音声再生のON/OFFをユーザーが明示的に制御できるようにする
- 既存機能（投稿・審査・モーダル表示）に回帰を出さずに音機能を追加する

---

## 📝 詳細仕様

### 機能要件
- Howler.jsを導入し、音声再生基盤を `useSound` フックで提供する
- 音声ファイルは `frontend/public/audio/` に配置し、IDとファイル名を1対1で管理する
- 標準フォーマットは `.mp3`、必要時は `.ogg` を併記する
- 初期状態はミュート（`isMuted = true`）とする
- ミュート状態は `localStorage` の `aruaru_sound_muted` に文字列 `'true' | 'false'` で保存する
- `aruaru_sound_muted` が未設定または不正値の場合は `'true'`（ミュート）へ正規化する
- 初回ユーザー操作（クリック/タップ/Enter/Space）で `audioUnlocked = true` を設定する
- `audioUnlocked = false` の間は、BGM/SEの再生要求を無視する
- ユーザーがミュートトグルをON（= 音声有効）にした後のみBGM/SEを再生する
- シーン別にBGMを切り替える
  - トップ画面: `bgm_top`（ループ）
  - 審査中画面: `bgm_judging`（ループ）
  - 審査結果モーダル表示中: 背景BGMは継続し、SEのみ重畳
- シーン切り替え時、BGMは500msでクロスフェードする
  - 旧BGM: 音量 `1.0 -> 0.0`（線形）
  - 新BGM: 音量 `0.0 -> 1.0`（線形）
- 同一シーンの再レンダリング時はBGM切り替えを実行しない
- 同時にループ再生されるBGMインスタンスは常に1つ以下とする
- SEは以下イベントで再生する（ユーザー操作1回につき1回）
  - 投稿成功時: `se_submit`
  - 結果モーダル開時: `se_result_open`
  - 再審査ボタン押下時: `se_retry`
- ミュートON（= 音声無効）へ切り替えた際は以下を即時実行する
  - 再生中BGMを停止
  - フェード中処理を中断
  - 以後の再生要求を無視
- 音声ファイルの読み込み失敗時は再生をスキップし、アプリは継続動作する

### 非機能要件
- 音声関連の未処理例外で画面遷移が停止しない
- ミュートトグル操作からUI状態反映まで200ms以内
- 連続遷移時も音切替でクリックノイズや無音1秒以上を発生させない
- モバイルブラウザの自動再生制約に対応し、ユーザー操作前は再生しない
- ログは開発時のみ `console.warn` を使用し、本番では機密情報を出力しない

### UI/UX設計
- フッターにサウンドトグルボタンを配置する
- ミュート中は `音声OFF`、有効時は `音声ON` と表示する
- トグルは `aria-pressed` を持つボタンとして実装する
- 音声ファイル読み込み失敗時はUI通知を出さず、開発者コンソールへログ出力する

---

## 🔧 技術仕様

### データモデル (DynamoDB)
| 項目 | 値 |
|------|-----|
| Table | N/A |
| PK | N/A |
| SK | N/A |
| GSI | N/A |

### API設計
| 項目 | 値 |
|------|-----|
| Method | N/A |
| Path | N/A |
| Request Body | N/A |
| Response (成功) | N/A |
| Response (失敗) | N/A |

### AIプロンプト設計
- N/A

### 実装対象ファイル（予定）
- `frontend/src/hooks/useSound.ts`（新規）
- `frontend/src/components/SoundToggleButton.tsx`（新規）
- `frontend/src/App.tsx`
- `frontend/src/components/ResultModal.tsx`
- `frontend/src/features/top/__tests__/useSound.red.test.ts`
- `frontend/src/features/top/__tests__/soundToggle.integration.red.test.tsx`
- `frontend/e2e/sound-playback.red.spec.ts`

### サウンドID定義
- BGM:
  - `bgm_top`
  - `bgm_judging`
- SE:
  - `se_submit`
  - `se_result_open`
  - `se_retry`

---

## 🧪 テスト計画 (TDD)

### Unit Test (Model/Service)
- [ ] 正常系:
  - 初期値で `isMuted = true` になる
  - `aruaru_sound_muted = 'false'` のときミュート解除で復元される
  - シーン変更時にクロスフェード（500ms）が実行される
  - 同一シーン再レンダリングではBGM再生呼び出しが増えない
- [ ] 異常系:
  - 音声ファイル読み込み失敗時に例外で落ちない
  - `localStorage` 不正値時に `'true'` へ正規化される
- [ ] 境界値:
  - ミュートトグル連打でも最終状態が一致する
  - 連続シーン遷移でもBGMインスタンス数が1以下を維持する

### Request Spec (API)
- [ ] `N/A` - API追加なし

### External Service (WebMock/VCR)
- [ ] モック対象:
  - Howlerの `play`, `fade`, `stop`, `unload` 呼び出し回数

### Component/Integration Test
- [ ] トグル押下で `aria-pressed` が切り替わる
- [ ] ミュートON遷移時に再生中BGMが停止する
- [ ] 初回ユーザー操作前は再生要求が無視される

### E2E Test (Playwright)
- [ ] 初期表示で `音声OFF` が表示される
- [ ] トグルで `音声ON` に変更でき、`localStorage` が `'false'` になる
- [ ] トップ画面→審査中画面遷移でBGM切替イベントが1回発生する
- [ ] 結果モーダル表示時に `se_result_open` 再生イベントが1回発生する
- [ ] ミュートONに戻すと再生イベントが追加発生しない

---

## ✅ 受入条件 (AC) - Given-When-Then

### 正常系 (Happy Path)
- [ ] **Given** 初回アクセス状態（`aruaru_sound_muted` 未設定）
      **When** 画面を表示する
      **Then** 音声はミュートで開始される
      **And** `localStorage` に `'true'` が保存される

- [ ] **Given** ユーザーが音声トグルをONにした
      **When** トップ画面から審査中画面へ遷移する
      **Then** BGMが500msでクロスフェードされる
      **And** ループ再生BGMは1つだけになる

- [ ] **Given** ユーザーが音声トグルをONにした
      **When** 審査結果モーダルを表示する
      **Then** `se_result_open` が1回再生される

### 異常系 (Error Path)
- [ ] **Given** 音声ファイル読み込みに失敗する
      **When** 再生処理が実行される
      **Then** アプリはクラッシュせず継続動作する
      **And** 開発時のみ警告ログを出力する

- [ ] **Given** `aruaru_sound_muted` に不正値が入っている
      **When** アプリを起動する
      **Then** ミュート状態で初期化される
      **And** 値は `'true'` に正規化される

### 境界値 (Edge Case)
- [ ] **Given** ユーザーがミュートトグルを短時間で連打する
      **When** ON/OFFを連続切り替えする
      **Then** 最終操作状態のみが反映される
      **And** BGM多重再生は発生しない

- [ ] **Given** ユーザー操作前（`audioUnlocked = false`）
      **When** 画面遷移やモーダル表示が発生する
      **Then** 再生要求は無視される

---

## 🔗 関連資料
- `docs/epics.md`（E18: BGM・SE再生）
- `docs/screen_design.md`
- `frontend/src/components/ResultModal.tsx`

---

**レビュアーへの確認事項:**
- [ ] 仕様の目的が明確か
- [ ] シーン別再生とクロスフェード仕様（500ms/音量遷移）が実装可能な粒度か
- [ ] 自動再生制約とミュート永続化の条件が明確か
- [ ] テスト計画は正常系/異常系/境界値を網羅しているか
- [ ] 受入条件はGiven-When-Then形式で記述されているか
- [ ] 既存機能と矛盾していないか
````
