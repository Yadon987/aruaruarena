import { defineConfig, devices } from '@playwright/test';

// ============================================================================
// 定数定義
// ============================================================================

/** CI環境でのリトライ回数 */
const CI_RETRY_COUNT = 2;

/** CI環境でのワーカー数 */
const CI_WORKER_COUNT = 1;

/** アクションタイムアウト（ミリ秒） */
const TIMEOUT_ACTION = 10 * 1000;

/** ナビゲーションタイムアウト（ミリ秒） */
const TIMEOUT_NAVIGATION = 30 * 1000;

/** WebServer起動待ちタイムアウト（ミリ秒） */
const TIMEOUT_WEB_SERVER = 120 * 1000;

/** Vite dev serverのURL */
const VITE_DEV_SERVER_URL = 'http://localhost:5173';

/**
 * Playwright E2Eテスト設定
 *
 * CI環境とローカル環境で最適な設定を自動切り替え
 */
export default defineConfig({
  // ========================================================================
  // テストファイルの設定
  // ========================================================================

  /** テストファイルが配置されているディレクトリ */
  testDir: './e2e',

  /** 並列実行を無効化（CI環境での安定性を確保） */
  fullyParallel: false,

  // ========================================================================
  // CI/ローカル環境での最適な設定
  // ========================================================================

  /**
   * リトライ回数
   * - CI環境: 2回（不安定なテストを許容）
   * - ローカル: 0回（即座に失敗を検知）
   */
  retries: process.env.CI ? CI_RETRY_COUNT : 0,

  /**
   * ワーカー数
   * - CI環境: 1（リソース制限とデバッグ容易性）
   * - ローカル: undefined（CPUコア数に応じて並列実行）
   */
  workers: process.env.CI ? CI_WORKER_COUNT : undefined,

  // ========================================================================
  // レポート設定
  // ========================================================================

  /**
   * テスト結果のレポーター
   * - html: ブラウザで閲覧可能なHTMLレポート
   * - blob: CI連携用のバイナリレポート
   */
  reporter: [
    ['html'],
    ['blob', { outputFile: 'blob-report/report.json' }],
  ],

  // ========================================================================
  // 共通設定
  // ========================================================================

  use: {
    /** 失敗時のみスクリーンショットを保存（ディスク容量節約） */
    screenshot: 'only-on-failure',

    /** 最初のリトライ時のみトレースを保存（デバッグ情報取得） */
    trace: 'on-first-retry',

    /** アクション（クリック、入力等）のタイムアウト */
    actionTimeout: TIMEOUT_ACTION,

    /** ページ遷移のタイムアウト */
    navigationTimeout: TIMEOUT_NAVIGATION,
  },

  // ========================================================================
  // WebServer設定
  // ========================================================================

  /**
   * Vite dev serverを自動起動
   * - テスト実行前にサーバーを起動
   * - CI環境: 毎回新規起動
   * - ローカル: 既存サーバーを再利用
   */
  webServer: {
    /** 起動コマンド */
    command: 'npm run dev',

    /** サーバーのURL */
    url: VITE_DEV_SERVER_URL,

    /** 起動待ちタイムアウト（ネットワーク環境によって調整可能） */
    timeout: TIMEOUT_WEB_SERVER,

    /** ローカル環境では既存サーバーを再利用 */
    reuseExistingServer: !process.env.CI,
  },

  // ========================================================================
  // テスト対象プロジェクト
  // ========================================================================

  /**
   * ブラウザプロジェクト設定
   * 現在はChromiumのみ対応（将来的にFirefox、Safariを追加可能）
   */
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
});
